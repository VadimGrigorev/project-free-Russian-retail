# Бесплатный проект Розница

A brief English description is at the end of the text.

Проект "розница" является абсолютно **бесплатной** альтернативой коммерческим кассовым и учетным системам для розничной торговли. Проект может использоваться как на рабочем месте кассира, так и как учетная программа для розничной компании. Проект написан для работы в системе [SunFlurry](http://sfsys.ru).

Исходные тексты проекта, выложенные здесь для скачивания, являются только частью проекта. Кроме исходных текстов, предоставляются также бинарные файлы, которые, в виде исполняемого приложения-установщика, можно [скачать](http://sfsys.ru/index.php/%D0%9F%D1%80%D0%BE%D0%B5%D0%BA%D1%82_%D0%A0%D0%BE%D0%B7%D0%BD%D0%B8%D1%86%D0%B0) с официального сайта SunFlurry. В процессе установки, создается рабочая копия с сервером и клиентом и программой Студия (позволяющей изменять исходные тексты проекта). Установщик также включает комплект исходных текстов, их не требуется скачивать с этого сайта. Однако, исходные тексты в программе-установщике могут иметь более старую ревизию по сравнению с текстами, представленными здесь.

Для разворачивания проекта в реальном рабочем магазине следует учесть несколько важных деталей:
- На тексты, распространяемые здесь, действует свободная [лицензия](http://sfsys.ru/download/EULASRC.txt) (базирующаяся на лицензии Apache версия 2.0).
- На бинарные файлы системы SunFlurry (сервер, клиент и Студия), действует свободная [лицензия](http://sfsys.ru/download/EULASOFT.txt), обладающая ограничениями при использовании в коммерческих целях. Изучите ее, пожалуйста, перед развертыванием проекта в реальном магазине.
- Несмотря на то, что для проекта написаны драйверы ККМ для наиболее распространенных производителей (Атол, Штрих-М, Вики Принт, возможно, другие с момента написания этого вступления), проект не работает с ККМ всех производителей. Это не значит, что драйверов для Вашего оборудования не появится в будущем. Кроме того, при наличии соответствующих знаний, Вы или Ваш технический специалист сможете написать нужный драйвер самостоятельно.
- Для технических специалистов и программистов есть полная документация по языку и его функциям с примерами, а также описание элементов интерфейса Студии, возможностей сервера, ключи командной строки запуска и т.д. Документация выполнена в формате Википедии и находится по адресу [http://sfsys.ru](http://sfsys.ru).


## Требовая к аппаратному обеспечению

- Операционная система: Windows XP и старше (возможна работа на Windows 2000, но она давно не проверялась).
- Процессор системы (и для сервера и для программ-клиентов): любой (вплоть до Intel Atom 1.1ГГц)
- Необходимый объем памяти: Достаточный для комфортабельной работы в операционной системе. Для больших баз данных, возможно нужно чуть больше памяти, чем в офисном компьютере. 


## Краткий список возможностей проекта на текущий момент

- При использовании проекта, как учетной системы:
  - Ведение любого количества юридических лиц и магазинов в одной базе.
  - Анализы продаж и закупок, ABC, XYZ-анализы, анализы наценки и прибыли, прогнозирование закупки товаров.
  - Система ценообразования и формирования цен, распечатка ценников.
  - Ведение бухгалтерского учета, ручные проводки, ведение учета по основным средствам.
    - Книга покупок и книга продаж, книга доходов и расходов, бух. баланс и отчет по прибыли.
  - Ведение финансового учета, ведение затрат, затраты по оплате и начислению.
    - Операционный капитал, отчет по прибылям и убыткам, маржинальная прибыль.
  - Ведение и учет маркетинга поставщиков (начисление и закрытие скидок и т.д.)
  - Ведение и анализы взаиморасчетов с поставщиками, платежная ведомость.
  - Ведение кассовых и банковских остатков. Ведение подотчета.
  - Ведение складских остатков в разрезе партий, марочный учет ЕГАИС и ГИС МТ.
  - Обрезание, объединение и перенос базы данных.
  - Обмен между базами данных, возможность выгрузки документов из периферийных баз данных в центральную.
  - Система прав отдельных пользователей.
- Возможности при использовании проекта, как кассового терминала:
  - Драйверы для популярных ККМ.
    - Продажа марочного товара ЕГАИС (алкоголь) и ГИС МТ (сигареты, молочная продукция и пр.). Работа с ФФД 1.2. 
  - Приемка поступлений ЕГАИС, автоматическое создание партий, работа с регистром 2, отчеты по сравнению с реальными остатками и прочее. Полный учет ЕГАИС.
    - Формирование декларации об объемах продаж алкоголя
  - Использование концепции "рабочее место" и "магазин", что позволяет настроить оборудование в ККТ магазина нужным образом и исключить проблемы с путаницей между оборудованием и пользователями.
  - Возможность выгружать и загружать информацию по протоколу Фронтол (к примеру, если центральная база будет использовать другую учетную систему). Другие способы обмена могут быть созданы Вашими или сторонними IT-специалистами.
  - Возможность программировать запреты на продажу алкоголя.
  - Возможность программировать торговые акции.
  - Удобная и простая самомасштабируемая форма рабочего места продавца
    - Операции типа: отложить чек, продолжить чек, возврат, аванс, кредит, временная замена прав для выполнения нужной операции и т.д. 
    - Возможности подбора товаров в чек, в т.ч. с помощью терминала сбора данных.
    - Быстрое закрытие чека, быстрая работа с комбинированными оплатами.

Дополнительная информация по проекту доступна [здесь](http://sfsys.ru/index.php/%D0%9F%D1%80%D0%BE%D0%B5%D0%BA%D1%82_%D0%A0%D0%BE%D0%B7%D0%BD%D0%B8%D1%86%D0%B0).

Пошаговая инструкция для установки и разворачивания проекта места доступна [здесь](http://sfsys.ru/index.php/%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B0_%D0%A0%D0%BE%D0%B7%D0%BD%D0%B8%D1%86%D0%B0).

## Вы скачали zip-архив с github, как открыть его с помощью Studio.exe?

Более правильным (но более трудоемким подходом) будет настройка визуального клиента Git для обновления Вашей версии проекта. Чтобы превратить Zip-архив в рабочий проект, достаточно распаковать его в любую пустую папку, создать в этой же папке подпапку **Compiled**, при этом папку **project-free-Russian-retail-main** можно переименовать просто в **Source**, после чего запустить Studio.exe, выбрать пункт меню "Файл", "Открыть" и, с помощью диалога открытия файла, открыть файл **sfstudio.sfprj**, внутри исходной папки.

## Пример кода начального заполнения справочника номенклатуры

Этот код можно использовать для создания своей версии загрузки номенклатуры из других источников (xls, xml, txt и пр.). Кусок кода, представленный здесь, можно запустить на закладке "Вычисление и исполнение" панели управления (административной панели) в рабочей программе (чтобы открыть панель управления, используйте пункт главного меню "Общие", "Административная панель").


```
  //Локальная функция установки цены, используется ниже по тексту
  Function ЛокУстановитьЦену(зН,ТипЦен,Цена,Магазин,ФлПродажнаяЦена)
    Дата:=BegOfDay(Date());

    Ц:=Ref.цЦены;
    Фл:=0;
    If Ц.Find("@Parent,ТипЦен",зН,ТипЦен) Then
      If Ц.Status()=1 Then
        Ц.Mark(0);
      EndIf;
    Else
      Ц.New();
      Ц.Parent(зН);
      Ц.ТипЦен:=ТипЦен;
      Ц.Save();
    EndIf;
    Ц.SetValue("Цена",Цена,Дата);

    //Кроме установки самой цены, создадим запись о том, что ценник для этой цены уже был распечатан
    //Если этого не сделать, необходимо будет хотя бы один раз распечатать ценники, чтобы новые цены начали работать
    If ФлПродажнаяЦена Then
      пЦ:=Ref.цПечатьЦенников;
      If пЦ.Find("@Parent,Магазин",зН,Магазин)=0 Then
        //Создаем
        пЦ.New();
        пЦ.Parent(зН);
        пЦ.Магазин:=Магазин;
        пЦ.ДатаПечати:=Дата;
        пЦ.ОбщаяСкидка:=0;
        пЦ.Save();
      ElseIf _Or(пЦ.ОбщаяСкидка<>0,isEmpty(пЦ.ДатаПечати),пЦ.ДатаПечати<Дата) Then
        пЦ.ДатаПечати:=Дата;
        пЦ.ОбщаяСкидка:=0;
        пЦ.Save();
      EndIf;
    EndIf;
  EndFunction

//Выбрать файл для загрузки
Файл:="";
If Not OpenFileDialog(Имя,"Выберите файл для загрузки:","Файлы txt (*.txt)|*.txt",0) Then
  Exit;
EndIf;
//Загрузить файл в объект Text
Т:=Text.Create(1);
Т.Load(Файл);

//Найдем по коду корневую папку, в которой будем создавать всю стрктуру папок
аКорневаяПапка:=DB("Ref.тмцНоменклатура","Code","000000000001");

//Найдем магазин, для которого происходит загрузка (требуется для создания цен)
аМагазин:=DB("Ref.рознМагазины","Code","000000000001");

//Единицы измерения (для упрощения примера)
аЕдиницаШт:=DB("Ref.тмцЕдиницыИзмерения","Name","шт");
аЕдиницаКг:=DB("Ref.тмцЕдиницыИзмерения","Name","кг");

//Цикл для каждой строки файла
For i:=1 To Т.Size() Do
  //Допустим, элементы строки разделены знаками табуляции (_TAB)
  //Допустим, файл также содержит папки товаров
  //Допустим, в файле есть внешние коды (артикли), с помощью которых мы можем найти, что уже было загружено, если загрузка была прервана

  //Получить текущую строку файла
  Стр:=Т.GetLine(i);
  СтрНаименование:=TearStr(Стр,_TAB);
  СтрАртикль:=TearStr(Стр,_TAB);
  СтрАртикльПапки:=TearStr(Стр,_TAB);
  ФлЭтоПапка:=Number(TearStr(Стр,_TAB));
  //Предусмотрим случай, когда для отделения дробной части используется запятая
  ЧлЦенаЗакупки:=Number(Replace(TearStr(Стр,_TAB),",","."));
  ЧлЦенаПродажи:=Number(Replace(TearStr(Стр,_TAB),",","."));
  ...

  //Если это новый элемент, создадим его, иначе найдем
  аН:=Ref.тмцНоменклатура;
  If Not аН.Find("ВнешнийТекстовыйКод",СтрАртикль) Then
    аН.New(ФлЭтоПапка);
    аН.СтрАртикль:=ВнешнийТекстовыйКод;
    аН.Save();
  ElseIf Not IsEmpty(аН.Name) Then
    //Пропускаем уже загруженный ранее элемент
    Continue;
  EndIf;

  //Помещаем элемент в нужную папку
  аПапка:=Ref.тмцНоменклатура;
  If IsEmpty(СтрАртикльПапки) Then
    аПапка:=аКорневаяПапка;
  ElseIf Not аПапка.Find("ВнешнийТекстовыйКод",СтрАртикльПапки) Then
    аПапка:=аКорневаяПапка;   
  EndIf;
  аН.Folder(аПапка);

  //Заполним наименование
  аН.Name:=СтрНаименование;
  //Если это папка, остальные реквизиты не будут нужны
  If аН.IsFolder() Then
    аН.Save();
    Continue;    
  EndIf;

  //Заполняем основные свойства товара
  аН.ВидНоменклатуры:=Enum.ВидыНоменклатуры.Товар;
  аН.СтавкаНДС:=?(ЧлСтавкаНДС=10,Enum.СтавкиНДС.НДС10,Enum.СтавкиНДС.НДС20);
  аН.ОбъемЛитров:=ЧлОбъем;
  аН.базМассаНетто:=ЧлМасса;
  //Обычно задана для табачных изделий
  аН.ЦенаМаксимальнаяПродажная:=ЧлЦенаМаксимальнаяПродажная;
  //Обычно задана для некоторых видов алкоголя
  аН.ЦенаМинимальнаяПродажная:=ЧлЦенаМинимальнаяПродажная;

  //Единицы
  аН.флВесовойТовар:=ЧлВесовойТовар;
  If аН.флВесовойТовар Then
    аН.базЕдиница:=аЕдиницаКг;
  Else
    аН.базЕдиница:=аЕдиницаШт;
  EndIf;
  аН.оснЕдиница:=аН.базЕдиница;
  аН.оснКоэффициент:=1;

  //ЕГАИС и пр.
  аН.флАлкогольнаяПродукция:=ЧлАлкогольнаяПродукция;
  аН.флПодлежитПрослеживаемости:=ЧлПодлежитПрослеживаемости;
  If ЧлАлкогольнаяПродукция Then
    аН.ЕГАИСКодАП:=ЧлКодАП;
    аН.флПартионныйУчет:=1;

    //Создадим или найдем элемент справочника тмцПартииТМЦ: аПартия
    //Здесь код опущен для улучшения читаемости
    ...

    аПартия.ЕГАИСКодАП:=ЧлКодАП;
    аПартия.ЕГАИСКодНоменклатуры:=..;
    аПартия.ЕГАИСКодПроизводителя:=..;
    аПартия.ЕГАИСКодСправок:=..;
    аПартия.Производитель:=..;
    аПартия.флМарочныйУчет:=..;
    аПартия.флИмпортнаяПродукция:=..;
    аПартия.флБезУпаковки:=..;
    ...
    аПартия.Save();    
  EndIf;
  If аН.флПодлежитПрослеживаемости Then
    аН.ГИСМТТоварнаяГруппа:=..;
  EndIf;


  //Установка закупочной и продажной цен
  ЛокУстановитьЦену(аН,аМагазин.ТипЦенПоступления,ЧлЦенаЗакупки,аМагазин);
  ЛокУстановитьЦену(аН,аМагазин.ТипЦенРеализации,ЧлЦенаПродажи,аМагазин,1);   

  //Сохраним все изменения в товаре
  аН.Save();
EndDo;
```

# Some brief English explanation to all the text above

This repository contains a free source project written for [SunFlurry](http://sfsys.ru) environment. The project can be used for Russian retail (as both POS and office software) as a free alternative to a number of commercial systems. Although you can write any kind of project in SunFlurry, unfortunately we do not have a full English documentation at the moment. You are welcome however to download and play with it, if you so desire.


